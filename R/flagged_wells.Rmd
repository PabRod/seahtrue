---
title: "flagged_wels"
author: "G.Smits"
date: "2023-01-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## R Markdown

**Flagged wells**:
Upon review of images in Wave, individual wells can be flagged for further
review. <br />

**Preprocessed dataset** <br />
The preprocess_plate_data function preprocesses the data by: <br />
* changing columns names <br />
* adding new time columns <br />
* adding injection info columns <br />
* add plate_id column <br />
* calculating background data <br />
* calculating raw pH emission data

**Preprocessed dataset + Flagged wells.** <br />
This Markdown shows how to add flagged wells to a preprocessed dataset,  <br />
produced by the R/preprocess_xfplate.R script. 

**Scores**
To decide what to flag, we use scores.


```{r source}
source(here::here("R", "process_background_wells.R"))
```

## Load quality control data.
**Quality control data is generated by another script** <br />
* Data can be generated by R Markdown for "Calculate background reference". <br />
* Corresponding script is called calc_bkgd_qc_ref.Rmd. <br />
* Location calc_bkgd_qc_ref.Rmd:  /R/ directory.

**Load dataset 1**: Plate stats
```{r load_plate_stats}
load(here::here("data", "qc_plate_ref_PBMC.rda"))
data("qc_plate_ref_PBMC", envir = environment())
my_qc_plate_ref <- qc_plate_ref_PBMC

print(my_qc_plate_ref)
```
**Load dataset 2**: Well stats
```{r load_well_stats}
load(here::here("data", "qc_well_ref_PBMC.rda"))

data("qc_well_ref_PBMC", envir = environment())
my_qc_well_ref <-qc_well_ref_PBMC

print(my_qc_well_ref)
```

**Load dataset 3**: Preprocessed dataset. <br />
This preprocessed dataset will get additional flagged data.
```{r preprocessed_xfplate, echo=FALSE}
load(here::here("data", "xf_plate_pr.rda"))
xf_plate_pr <- xf_plate_pr
```
## Set flagged wells

**Input**: <br />
preprocessed seahorse xf plate df <br />
Produced by: preprocess_xfplate.R script located in /R/ directory.

**Output**: <br />
preprocessed seahorse xf plate  <br />
+ flagged well data.

Flag background wells based on score. 
```{r flaged_bkgd_wells, echo=FALSE}

flag_bkgd_wells <- function(well_scores, score_cutoff) {
  well_scores <- well_scores %>%
    dplyr::mutate(
      flagged =
        dplyr::case_when(
          total_score > score_cutoff ~ TRUE, # CUTOFF = 9, score 6-9: green, 10-12: orange, 13 - 18 red
          TRUE ~ FALSE
        )
    )

  flagged_bkgd_wells <- well_scores %>%
    dplyr::filter(flagged == TRUE) %>%
    dplyr::pull(well)

  return(flagged_bkgd_wells)
}

```

```{r set_flagged_wells, echo=FALSE}
  # calculate scores and flagged wells
  qc_scores <- get_bkgd_qc_scores(
    xf_plate_pr %>%
      dplyr::pull(raw_data) %>%
      purrr::pluck(1),
    my_qc_well_ref,
    my_qc_plate_ref
  )

  O2_flagged_bkgd_wells <- flag_bkgd_wells(qc_scores$well_scores,
    score_cutoff = 10
  )
  
  # add flagged wells to assay info
  assay_info_list <- as.list(preprocessed_xfplate$assay_info[[1]])
  assay_info_list <- assay_info_list %>%
    purrr::list_merge(O2_flagged_bkgd_wells = O2_flagged_bkgd_wells)

  preprocessed_xfplate$assay_info <- list(assay_info_list)

```


