---
title: "flagged_wels"
author: "G.Smits"
date: "2023-01-30"
output: html_document
---
## Background

**Preprocessed dataset + Flagged wells** <br />
This Markdown shows how to add flagged wells to a preprocessed seahorse dataset.  <br />

**Flagged wells** <br />
Upon review of images with the Agilent Wave software, individual wells can be flagged for further
review. <br />

**Preprocessed dataset** <br />
To produce the preprocessed dataset we read a seahorse excel file containing seahorse information. <br />
This Excel file is converted from the assay result file (.asyr). <br />
Assay result files are downloaded from the Agilent Seahorse XF Wave software.

The preprocessed dataset will be produced by the R/preprocess_xfplate.R script. <br />
The preprocess_plate_data function preprocesses the data by: <br />
* changing columns names <br />
* adding new time columns <br />
* adding injection info columns <br />
* add plate_id column <br />
* calculating background data <br />
* calculating raw pH emission data

## Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)

source(here::here("R", "process_background_wells.R"))
source(here::here("R", "preprocess_xfplate.R"))
source(here::here("R", "read_xfplate.R"))
source(here::here("R", "utils.R"))
```

**File location**: <br />
The $\color{red}{\text{here}}$ function from the here package makes sure that the file location is relative to your project root.

### Step 1 Set path: <br />
Set path to the seahorse excel file.
```{r set_path_to_seahorse_file}

filepath_seahorse <- here::here("inst", "extdata", "20200110 SciRep PBMCs donor B.xlsx")

```

## Load quality control data.

We have to load quality control data first. <br />
Our data files are located at the /data directory. 

**Quality control data is generated by another script** <br />
* Data can be generated by R Markdown for "Calculate background reference". <br />
* Corresponding script is called calc_bkgd_qc_ref.Rmd. <br />
* Location calc_bkgd_qc_ref.Rmd:  /R/ directory.

### Step 2 load dataset 1: Plate stats
```{r load_plate_stats}
load(here::here("data", "qc_plate_ref_PBMC.rda"))
my_qc_plate_ref <- qc_plate_ref_PBMC[[1]]

print(my_qc_plate_ref)
```
### Step 3 load dataset 2: Well stats
```{r load_well_stats}
load(here::here("data", "qc_well_ref_PBMC.rda"))

my_qc_well_ref <- qc_well_ref_PBMC[[1]]

print(my_qc_well_ref)
```

### Step 4 Create and load dataset 3: Preprocessed dataset. <br />
Create preprocessed dataset: 
* Read and preprocess the seahorse excel file. <br />
* A preprocessed dataset will be generated. <br />
* This preprocessed dataset will get the additional flagged data.
```{r preprocessed_xfplate, echo=FALSE}

## read and preprocess
preprocessed_xfplate <-
  filepath_seahorse %>%
  read_xfplate() %>%
  preprocess_xfplate()

usethis::use_data(preprocessed_xfplate, 
                  overwrite = 'TRUE')

load(here::here("data", "preprocessed_xfplate.rda"))
preprocessed_xfplate <- preprocessed_xfplate

print(preprocessed_xfplate)
```
## flagged wells

### Step 5: Set well flags

**Input** <br />
preprocessed seahorse dataset  <br />
Produced by: preprocess_xfplate.R script located in /R/ directory.

**Output** <br />
preprocessed seahorse dataset <br />
+ flagged well data

**Score calculation** <br />
We use the well and plate quality reference PBMC data. <br />
These data are used to calculate scores for each well. <br />

**Result** 
* Score for seahorse xf wells $\color{blue}{\text{(well scores)}}$ 
* Score for seahorse xf plates $\color{blue}{\text{(plate scores)}}$
```{r set_flagged_wells, echo=FALSE}
my_qc_well_ref <- qc_well_ref_PBMC
my_qc_plate_ref <- qc_plate_ref_PBMC

# calculate scores and flagged wells
qc_scores <- get_bkgd_qc_scores(
  preprocessed_xfplate %>%
    dplyr::pull(raw_data) %>%
    purrr::pluck(1),
  my_qc_well_ref[[1]],
  my_qc_plate_ref[[1]]
)

print(qc_scores)

```

The function in the chunk below flags background wells based on scores and cutoff (score_cutoff). <br />
It returns background wells that are flagged. <br /> 

**Well scores**: For the next chunk of code we use the $\color{blue}{\text{well scores}}$ that we received at our previous step. <br />
**Cutoff**: We set a cutoff for for these scores (score_cutoff). <br />
**Background wells** "A01","A12" "H01" "H12".

**Background wells flagged**  <br />
If all background wells are flagged all background wells are printed. <br />
These values will be put into a variable. <br />

**No background wells flagged** <br />
If no background wells are flagged the output value will be character(0).
```{r flagged_bkgd_wells, echo=FALSE}

flag_bkgd_wells <- function(well_scores, score_cutoff) {
  well_scores <- well_scores %>%
    dplyr::mutate(
      flagged =
        dplyr::case_when(
          total_score > score_cutoff ~ TRUE, # CUTOFF = 9, score 6-9: green, 10-12: orange, 13 - 18 red
          TRUE ~ FALSE
        )
    )

  flagged_bkgd_wells <- well_scores %>%
    dplyr::filter(flagged == TRUE) %>%
    dplyr::pull(well)

  return(flagged_bkgd_wells)

}

  O2_flagged_bkgd_wells <- flag_bkgd_wells(qc_scores$well_scores,
  score_cutoff = 10)

  print(O2_flagged_bkgd_wells)
```
Both $\color{blue}{\text{well scores}}$ and $\color{blue}{\text{cutoff}}$ are used to decide which wells we want to flag. <br />

### Step 6: Add flagged wells
Flagged wells will be added to our preprocessed dataset. <br />
The preprocessed dataset contains a dataframe (tibble) for assay information. <br />
Flagged wells will be added to this assay information dataframe. <br />

Note: flagged wells column is located at the last column.

```{r add_flagged_bkgd_wells, echo=FALSE}

# add flagged wells to assay info
assay_info_list <- as.list(preprocessed_xfplate$assay_info[[1]])
assay_info_list <- assay_info_list %>%
  purrr::list_merge(O2_flagged_bkgd_wells = O2_flagged_bkgd_wells)

preprocessed_xfplate$assay_info <- list(assay_info_list)

print(preprocessed_xfplate$assay_info)

```
