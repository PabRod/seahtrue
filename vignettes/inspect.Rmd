---
title: "inspect"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{inspect}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


### load libraries

```{r load packages}
suppressPackageStartupMessages({
  library(dplyr)
  library(seahtrue)
})

# in your own workflow you don't have to supresses messages 
# off course, this is used here only for cleaner vignettes

```

### Inspect the revived data

```{r explore output 1}
revive_output_donor_A %>%  
  dplyr::glimpse()

```

Our data starts with 4 columns of identifiers. `plate_id`, `filepath_seahorse`, `date_run` and `date_processed`, this keeps the data easily traceable with ids on the top level. After that, 5 columns of nested tibbles follow. The `assay_info` column contains a tibble/dataframe with information that was stored in the experimental file. This is either information that the user put into the software before running the experiment, after running the software when processing the data, or was generated by the software. The next colum is the `injection_info` containing measurement, interval and injection. Then the two data columns for `raw_data` and `rate_data` are listed as tibble/dataframe. The final column is the `validation_output` that has the output of the validations as well as its rules. In the next sections, we will explore each data output separately.

#### Rate data

The `rate_data` is what scientist typically use for their interpretation of their XF experiments. It contains the calculated OCR (oxygen consumption rate) and ECAR (extracellular acidification rate) values, together with the PER (proton efflux rate). The PER is calculated from ECAR when the buffer capacity is known and set in the experiment. In our `rate_data` we only have the OCR and ECAR data, since PER can be easily calculated.

```{r}
revive_output_donor_A %>%  
  purrr::pluck("rate_data", 1)

```
The `rate_data` has `well`,`measurement`, `group` identifiers for each row followed by the `time_wave` column which provides the time of the measurement in minutes, and the OCR and ECAR data columns. Also the `cell_n` and `flagged_well` status is joined in this dataframe. This provides all information for exploring and plotting the data. Since the OCR and ECAR data can be exported with either background on or off, the read functions in the seahtrue package determine whether the OCR and ECAR are background corrected or not, based on whether the Background wells have an OCR of zero. If the data was not corrected for background the the OCR is corrected while reading the .xlsx file. The background corrected data is given in `OCR_wave_bc` and `ECAR_wave_bc`. If the data was exported without background correction the `OCR_wave` and `ECAR_wave` data columns would contain the non corrected OCR and ECAR.

#### Raw data

The `raw_data` tibble contains the raw data that is collected in an XF experiment. This is essential data that can give detailed insights on the quality of the assay. Apart from the data that is presented in the raw data sheet of the .xlsx, some preprocessing output is given. Such as the timescale in seconds (`timescale`) and minutes (`minutes`), as well as an `interval` and `injection` id. Also, the background corrected raw data values for pH, O2 and its emissions are given. Again, just like in the `rate_data` tibble, the `cell_n` and `flagged_well` status is given.

```{r}
revive_output_donor_A %>%  
  purrr::pluck("raw_data", 1)

```

#### Assay info

The `assay_info` has information from user or software provided meta data that is associated with the experiment and plate. For example, the barcode of the cartridge that was used:

```{r}
revive_output_donor_A %>%  
  purrr::pluck("assay_info", 1) %>% 
  pull(cartridge_barcode)

```

The XF analyzer reads for each cartridge a barcode that is then associated with the assay. There is some information in the barcode that the software uses for OCR calculation. The emission of the fluorescent O2 sensors at zero oxygen `F0` (see Gerencser et al. (2009) Quantitative microplate-based respirometry with correction for oxygen diffusion. Anal Chem 81:6868, for details) is derived from the Stern-Volmer constant `KSV`. Where the emission at ambient oxygen is typically set at 12500 AU and ambient oxygen levels in wells in culture medium is set to 151.6900241 mmHg.

```{r}
# KSV in barcode
revive_output_donor_A %>%  
  purrr::pluck("assay_info", 1) %>% 
  pull(cartridge_barcode) %>% 
  stringr::str_sub(-18, -13)
  
# KSV in assay info sheet
revive_output_donor_A %>%  
  purrr::pluck("assay_info", 1) %>% 
  pull(KSV) 

# F0 can be calculated using the stern-volmer equation
# and the info 
# emission target at ambient O2 = 12500
# O2 level at ambient in sample medium in well = 151.69
#
# F0/F = 1 + KSV*O2
# F0 = (1+KSV*O2)*F
# F0 = (1+ KSV*151.69)*12500

# F0 from assay info sheet
revive_output_donor_A %>%  
  purrr::pluck("assay_info", 1) %>% 
  pull(F0) 
```

Apart from user and software generated meta info, the functions in the seahtrue package also put some relevant info into this tibble. Such as the time to start the actual measurements (`minutes_to_start_measurement_one`), that shows how long the user took to insert the cell plate and start running the measurements. The timer starts at t = 0 minutes when the cartridge is calibrated by the user.

```{r}
revive_output_donor_A %>%  
  purrr::pluck("assay_info", 1) %>% 
  pull(minutes_to_start_measurement_one)

```

Apart from the `assay_info` there can be some more meta info associated with the data tibbles in the form of `attributes`. These can also be viewed as shown in the following examples:

```{r}
revive_output_donor_A %>%  
  purrr::pluck("rate_data", 1) %>% str()

```

```{r}
  revive_output_donor_A %>%  
    purrr::pluck("rate_data", 1) %>% 
    attributes() %>% 
    purrr::pluck("was_background_corrected")

```

#### Injection info

Since every XF experiment uses pertubations with chemicals or nutrients the `injection_info` is important for interpretation of the experiment. The injection info can be plucked from the data tibble.

```{r}
  revive_output_donor_A %>%  
    purrr::pluck("injection_info", 1)

```

#### Validation output

The `validation_output` list will be described in a separate vignette.